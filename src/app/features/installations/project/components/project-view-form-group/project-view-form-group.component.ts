/* @autogenerated */
import { SelectorProvider } from 'app/common/data/selector-provider';
import { SiteRepository } from 'app/features/organization/site/repository/site-repository.service';
import { Tick } from 'app/common/data/repository/repository.model';
import { Acl } from 'app/common/data/acl/acl.model';
import { ProjectRepository } from 'app/features/installations/project/repository/project-repository.service';
import { SubFormEditable } from 'app/common/toolkit/editable/subform-editable';
import { Project } from 'app/features/installations/project/model/project.model';
import { BaseEditable } from 'app/common/toolkit/editable/base-editable';
import { Validators, FormGroup, FormControl } from '@angular/forms';
import { Site, SiteFilter } from 'app/features/organization/site/model/site.model';
import { effect, computed, Component, input } from '@angular/core';

@Component({
  selector: 'project-view-form-group',
  templateUrl: './project-view-form-group.component.html',
  styleUrls: ['./project-view-form-group.component.scss'],
  providers: BaseEditable.getValidableAccessorProvider(ProjectViewFormGroupComponent),
  standalone: false,
})
export class ProjectViewFormGroupComponent extends SubFormEditable<Project> {
  acl: Tick<{ generic: Acl; specific: Acl }, string | null>;
  uid = computed(() => this.value()?.uid);
  siteProvider: SelectorProvider<Site, { $ref: string }>;
  siteFilter = input<SiteFilter>({ limit: 100 });
  public constructor(projectRepository: ProjectRepository, siteRepository: SiteRepository) {
    super(
      new FormGroup({
        uid: new FormControl<string>(''),
        site: new FormControl<any>(null, [Validators.required]),
        name: new FormControl<string>('', [Validators.required]),
        description: new FormControl<string>(''),
        operationMode: new FormControl<any>('single', [Validators.required]),
        plannedAt: new FormControl<Date>(new Date(), [Validators.required]),
        plannedConfigAt: new FormControl<Date>(new Date()),
        status: new FormControl<any>('planned', [Validators.required]),
        version: new FormControl<number>(0),
      }),
    );
    this.acl = projectRepository.acl();
    effect(() => {
      this.acl.fetch(this.uid() || null);
    });
    effect(() => {
      const vals = this.acl();
      const value = this.value();
      const on = this.uid() ? vals?.specific : vals?.generic;
      setTimeout(() => {
        this.definedFixed.set(on?.fields?.noEditables || []);
        this.definedHidden.set(on?.fields?.noVisibles || []);
      });
    });
    this.siteProvider = siteRepository.selectorProvider(this.siteFilter);
    this.defaultValues = () => {
      return {
        uid: '',
        site: null,
        name: '',
        description: '',
        operationMode: 'single',
        plannedAt: new Date(),
        plannedConfigAt: new Date(),
        status: 'planned',
        version: 0,
      };
    };
  }
}
